"""Storage service for filesystem operations.

Only stores session name mappings and user settings - SDK handles all message history.
"""

import json
from datetime import datetime
from pathlib import Path

from copilot_agent_console.app.config import DEFAULT_CWD, DEFAULT_MODEL, METADATA_FILE, SESSIONS_DIR, SETTINGS_FILE, ensure_directories
from copilot_agent_console.app.models.session import Session


class StorageService:
    """Handles session name storage and user settings - SDK handles messages."""

    def __init__(self) -> None:
        ensure_directories()
        self._init_metadata()
        self._init_settings()

    def _init_metadata(self) -> None:
        """Initialize metadata file if it doesn't exist."""
        if not METADATA_FILE.exists():
            metadata = {
                "version": "1.0",
                "created_at": datetime.utcnow().isoformat() + "Z",
            }
            METADATA_FILE.write_text(json.dumps(metadata, indent=2), encoding="utf-8")

    def _init_settings(self) -> None:
        """Initialize settings file if it doesn't exist."""
        if not SETTINGS_FILE.exists():
            settings = {
                "default_model": DEFAULT_MODEL,
                "default_cwd": DEFAULT_CWD,
            }
            SETTINGS_FILE.write_text(json.dumps(settings, indent=2), encoding="utf-8")

    def _session_dir(self, session_id: str) -> Path:
        """Get directory for a session."""
        return SESSIONS_DIR / session_id

    def _session_file(self, session_id: str) -> Path:
        """Get session metadata file path."""
        return self._session_dir(session_id) / "session.json"

    def save_session(self, session: Session) -> None:
        """Save session metadata (name, cwd, model, mcp_servers, tools) to disk.
        
        Note: Timestamps are NOT saved - they come from the SDK at runtime.
        """
        session_dir = self._session_dir(session.session_id)
        session_dir.mkdir(parents=True, exist_ok=True)

        # Only save the fields we manage, not timestamps (SDK provides those)
        session_data = {
            "session_id": session.session_id,
            "session_name": session.session_name,
            "model": session.model,
            "cwd": session.cwd,
            "mcp_servers": session.mcp_servers,
            "tools": session.tools,
            "system_message": session.system_message,
            "name_set": session.name_set,
            "agent_id": session.agent_id,
            "trigger": session.trigger,
        }
        self._session_file(session.session_id).write_text(
            json.dumps(session_data, indent=2, default=str), encoding="utf-8"
        )

    def load_session(self, session_id: str) -> dict | None:
        """Load session metadata from disk (without timestamps)."""
        session_file = self._session_file(session_id)
        if not session_file.exists():
            return None

        return json.loads(session_file.read_text(encoding="utf-8"))

    def list_all_sessions(self) -> list[dict]:
        """List all stored session metadata (without timestamps)."""
        sessions = []
        if SESSIONS_DIR.exists():
            for session_dir in SESSIONS_DIR.iterdir():
                if session_dir.is_dir():
                    session_file = session_dir / "session.json"
                    if session_file.exists():
                        try:
                            data = json.loads(session_file.read_text(encoding="utf-8"))
                            sessions.append(data)
                        except (json.JSONDecodeError, IOError):
                            pass
        return sessions

    def delete_session(self, session_id: str) -> bool:
        """Delete session metadata from disk."""
        import shutil
        session_dir = self._session_dir(session_id)
        if not session_dir.exists():
            return False

        shutil.rmtree(session_dir)
        return True

    def get_settings(self) -> dict:
        """Get user settings."""
        if SETTINGS_FILE.exists():
            settings = json.loads(SETTINGS_FILE.read_text(encoding="utf-8"))
            # Ensure default_cwd exists (for existing settings files)
            if "default_cwd" not in settings:
                settings["default_cwd"] = DEFAULT_CWD
            return settings
        return {"default_model": DEFAULT_MODEL, "default_cwd": DEFAULT_CWD}

    def update_settings(self, settings: dict) -> dict:
        """Update user settings."""
        current = self.get_settings()
        current.update(settings)
        SETTINGS_FILE.write_text(json.dumps(current, indent=2), encoding="utf-8")
        return current


# Singleton instance
storage_service = StorageService()
